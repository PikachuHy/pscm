# pscm_cc åŠŸèƒ½ç°çŠ¶ä¸å¼€å‘è§„åˆ’

æœ¬æ–‡æ¡£æ€»ç»“ pscm_cc çš„ç°æœ‰åŠŸèƒ½ç‰¹æ€§ï¼Œå¹¶è§„åˆ’å®ç°é©±åŠ¨ TeXmacs æ‰€éœ€çš„åŠŸèƒ½ã€‚

pscm_cc å·²å®ç° Scheme çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å®Œæ•´çš„ç±»å‹ç³»ç»Ÿ
- âœ… æ ¸å¿ƒç‰¹æ®Šå½¢å¼
- âœ… Continuation æ”¯æŒ
- âœ… ä¸°å¯Œçš„å†…ç½®å‡½æ•°

## ä¸€ã€ç°æœ‰åŠŸèƒ½æ€»ç»“

### 1.1 æ ¸å¿ƒåŸºç¡€è®¾æ–½ âœ…

- **ç±»å‹ç³»ç»Ÿ**ï¼šç»Ÿä¸€ `SCM` ç±»å‹ï¼Œæ”¯æŒ 16 ç§æ•°æ®ç±»å‹
- **è§£æå™¨**ï¼šé€’å½’ä¸‹é™è§£æå™¨ï¼Œæ”¯æŒå®Œæ•´ Scheme è¯­æ³•
- **æ±‚å€¼å™¨**ï¼šæ”¯æŒå°¾é€’å½’ä¼˜åŒ–ï¼Œæ¨¡å—åŒ–ç‰¹æ®Šå½¢å¼å¤„ç†
- **ç¯å¢ƒç³»ç»Ÿ**ï¼šè¯æ³•ä½œç”¨åŸŸï¼Œé“¾è¡¨ç»“æ„ç¯å¢ƒ
- **é”™è¯¯æŠ¥å‘Š**ï¼šæºä½ç½®è·Ÿè¸ªï¼Œæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 1.2 æ•°æ®ç±»å‹æ”¯æŒ âœ…

| ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `NIL` | âœ… | ç©ºåˆ—è¡¨ |
| `LIST` | âœ… | åˆ—è¡¨å’Œç‚¹å¯¹ |
| `NUM` | âœ… | æ•´æ•° |
| `FLOAT` | âœ… | æµ®ç‚¹æ•° |
| `RATIO` | âœ… | æœ‰ç†æ•°ï¼ˆåˆ†æ•°ï¼‰ |
| `CHAR` | âœ… | å­—ç¬¦ |
| `STR` | âœ… | å­—ç¬¦ä¸² |
| `SYM` | âœ… | ç¬¦å· |
| `BOOL` | âœ… | å¸ƒå°”å€¼ |
| `PROC` | âœ… | Scheme è¿‡ç¨‹ |
| `FUNC` | âœ… | C/C++ å‡½æ•° |
| `CONT` | âœ… | Continuation |
| `MACRO` | âœ… | å® |
| `HASH_TABLE` | âœ… | å“ˆå¸Œè¡¨ |
| `VECTOR` | âœ… | å‘é‡ |

### 1.3 ç‰¹æ®Šå½¢å¼æ”¯æŒ âœ…

- **å®šä¹‰**ï¼š`define`, `define-macro`, `lambda`, `set!`
- **æ§åˆ¶æµ**ï¼š`if`, `cond`ï¼ˆæ”¯æŒ `else` å’Œ `=>`ï¼‰, `begin`
- **ä½œç”¨åŸŸ**ï¼š`let`, `let*`, `letrec`ï¼ˆé€šè¿‡å®å±•å¼€ï¼‰
- **å¾ªç¯**ï¼š`do`, `for-each`, `map`
- **å¼•ç”¨**ï¼š`quote`, `quasiquote`
- **å‡½æ•°åº”ç”¨**ï¼š`apply`
- **Continuation**ï¼š`call/cc`, `call-with-current-continuation`
- **å¤šå€¼**ï¼š`call-with-values`, `values`
- **åŠ¨æ€æ§åˆ¶**ï¼š`dynamic-wind`

### 1.4 å†…ç½®å‡½æ•°æ”¯æŒ âœ…

#### ç±»å‹æ£€æŸ¥
`procedure?`, `boolean?`, `null?`, `pair?`, `char?`, `number?`

#### åˆ—è¡¨æ“ä½œ
`car`, `cdr`, `cadr`, `cddr`, `caddr`, `cons`, `list`, `append`, `list-head`, `list-tail`, `last-pair`, `set-car!`, `set-cdr!`

#### æ•°å­—è¿ç®—
- ç®—æœ¯ï¼š`+`, `-`, `*`, `/`, `expt`, `abs`
- æ¯”è¾ƒï¼š`=`, `<`, `>`, `<=`, `>=`, `negative?`
- ç±»å‹æå‡ï¼šæ•´æ•°ã€æµ®ç‚¹æ•°ã€åˆ†æ•°æ··åˆè¿ç®—

#### å­—ç¬¦æ“ä½œ
`char?`, `char->integer`, `integer->char`

#### å­—ç¬¦ä¸²æ“ä½œ
`string-length`, `make-string`, `string-ref`, `string-set!`, `display`, `write`, `newline`

#### ç›¸ç­‰æ€§åˆ¤æ–­
`eq?`, `eqv?`, `equal?`

#### å…³è”åˆ—è¡¨
`assv`, `assoc`, `acons`, `assoc-ref`, `assoc-set!`, `assq-set!`, `assoc-remove!`

#### å“ˆå¸Œè¡¨
å®Œæ•´çš„å“ˆå¸Œè¡¨æ“ä½œé›†ï¼ˆåˆ›å»ºã€è®¾ç½®ã€è·å–ã€åˆ é™¤ã€éå†ï¼‰

#### å…¶ä»–
`gensym`, `not`, `eval`

### 1.5 C/C++ å‡½æ•°æ³¨å†Œ âœ…

- `scm_define_function`ï¼šå›ºå®šå‚æ•°å‡½æ•°
- `scm_define_generic_function`ï¼šæ³›å‹å‡½æ•°
- `scm_define_vararg_function`ï¼šå¯å˜å‚æ•°å‡½æ•°

## äºŒã€ç¼ºå¤±åŠŸèƒ½åˆ†æ

### 2.1 ç«¯å£ï¼ˆPortï¼‰ç³»ç»Ÿ âŒ

**ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜

TeXmacs éœ€è¦æ–‡ä»¶ I/O å’Œå­—ç¬¦ä¸²ç«¯å£åŠŸèƒ½ã€‚

#### ç¼ºå¤±åŠŸèƒ½
- **ç«¯å£ç±»å‹**ï¼šè¾“å…¥ç«¯å£ã€è¾“å‡ºç«¯å£
- **æ–‡ä»¶ç«¯å£**ï¼š
  - `open-input-file filename` â†’ è¾“å…¥ç«¯å£
  - `open-output-file filename` â†’ è¾“å‡ºç«¯å£
  - `close-input-port port`
  - `close-output-port port`
- **å­—ç¬¦ä¸²ç«¯å£**ï¼š
  - `open-input-string string` â†’ è¾“å…¥ç«¯å£
  - `open-output-string` â†’ è¾“å‡ºç«¯å£
  - `get-output-string port` â†’ å­—ç¬¦ä¸²
- **ç«¯å£æ“ä½œ**ï¼š
  - `read port`ï¼šä»ç«¯å£è¯»å– Scheme å¯¹è±¡
  - `read-char port`ï¼šè¯»å–å­—ç¬¦
  - `peek-char port`ï¼šæŸ¥çœ‹ä¸‹ä¸€ä¸ªå­—ç¬¦
  - `eof-object? obj`ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶ç»“æŸå¯¹è±¡
  - `char-ready? port`ï¼šåˆ¤æ–­å­—ç¬¦æ˜¯å¦å°±ç»ª
- **ç«¯å£åŒ…è£…**ï¼š
  - `call-with-input-file filename proc`
  - `call-with-output-file filename proc`
  - `call-with-input-string string proc`
  - `call-with-output-string proc`

#### å®ç°è¦ç‚¹
1. æ·»åŠ  `PORT` ç±»å‹åˆ° `SCM::Type`
2. å®šä¹‰ `SCM_Port` ç»“æ„ä½“ï¼ˆæ–‡ä»¶æŒ‡é’ˆæˆ–å­—ç¬¦ä¸²ç¼“å†²åŒºï¼‰
3. å®ç°ç«¯å£åˆ›å»ºã€è¯»å†™ã€å…³é—­æ“ä½œ
4. é›†æˆåˆ°è§£æå™¨ï¼ˆ`parse_file` å·²å­˜åœ¨ï¼Œéœ€è¦ç«¯å£ç‰ˆæœ¬ï¼‰

### 2.2 æ–‡ä»¶åŠ è½½ç³»ç»Ÿ âš ï¸

**ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜

#### éƒ¨åˆ†å®ç°
- `parse_file`ï¼šè§£ææ–‡ä»¶ä¸º AST åˆ—è¡¨ âœ…
- `load`ï¼šåŠ è½½å¹¶æ‰§è¡Œæ–‡ä»¶ âŒ

#### ç¼ºå¤±åŠŸèƒ½
- `load filename`ï¼šåŠ è½½å¹¶æ‰§è¡Œ Scheme æ–‡ä»¶
- `primitive-load filename`ï¼šåº•å±‚åŠ è½½å‡½æ•°ï¼ˆGuile å…¼å®¹ï¼‰
- åŠ è½½è·¯å¾„ç®¡ç†ï¼š`%load-path`

#### å®ç°è¦ç‚¹
1. å®ç° `load` å‡½æ•°ï¼Œè°ƒç”¨ `parse_file` å¹¶é€ä¸ªæ±‚å€¼
2. æ”¯æŒç›¸å¯¹è·¯å¾„å’Œæœç´¢è·¯å¾„
3. é”™è¯¯å¤„ç†ï¼šæ–‡ä»¶ä¸å­˜åœ¨ã€è§£æé”™è¯¯ç­‰

### 2.3 æ¨¡å—ç³»ç»Ÿ âŒ

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ ä¸­

TeXmacs å¤§é‡ä½¿ç”¨æ¨¡å—ç³»ç»Ÿç»„ç»‡ä»£ç ã€‚

#### ç¼ºå¤±åŠŸèƒ½
- **æ¨¡å—å®šä¹‰**ï¼š
  - `define-module name`ï¼šå®šä¹‰æ¨¡å—
  - `current-module`ï¼šè·å–å½“å‰æ¨¡å—
- **æ¨¡å—ä½¿ç”¨**ï¼š
  - `use-modules spec ...`ï¼šä½¿ç”¨æ¨¡å—
  - `module-use! module spec`ï¼šæ¨¡å—æ“ä½œ
- **æ¨¡å—æŸ¥è¯¢**ï¼š
  - `resolve-module name`ï¼šè§£ææ¨¡å—
  - `module-ref module symbol`ï¼šè·å–æ¨¡å—å˜é‡
  - `module-map proc module`ï¼šéå†æ¨¡å—ç»‘å®š
- **æ¨¡å—å¯¼å‡º**ï¼š
  - `define-public name value`ï¼šå®šä¹‰å¹¶å¯¼å‡º
  - `export symbol ...`ï¼šå¯¼å‡ºç¬¦å·
  - `re-export symbol ...`ï¼šé‡æ–°å¯¼å‡º
- **æ¨¡å—æ¥å£**ï¼š
  - `%module-public-interface`ï¼šæ¨¡å—å…¬å…±æ¥å£

#### å®ç°è¦ç‚¹
1. æ·»åŠ  `MODULE` ç±»å‹
2. æ¨¡å—ç¯å¢ƒç®¡ç†ï¼šæ¯ä¸ªæ¨¡å—æœ‰ç‹¬ç«‹ç¯å¢ƒ
3. æ¨¡å—è§£æï¼šæ”¯æŒæ¨¡å—è·¯å¾„æœç´¢
4. æ¨¡å—æ¥å£ï¼šå…¬å…±æ¥å£ä¸ç§æœ‰æ¥å£åˆ†ç¦»

### 2.4 é”™è¯¯å¤„ç†æœºåˆ¶ âš ï¸

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ ä¸­

#### éƒ¨åˆ†å®ç°
- `eval_error`ï¼šé”™è¯¯æŠ¥å‘Š âœ…
- æºä½ç½®è·Ÿè¸ª âœ…

#### ç¼ºå¤±åŠŸèƒ½
- **å¼‚å¸¸æ•è·**ï¼š
  - `catch tag thunk handler`ï¼šæ•è·å¼‚å¸¸
  - `throw key args ...`ï¼šæŠ›å‡ºå¼‚å¸¸
- **é”™è¯¯å¯¹è±¡**ï¼š
  - é”™è¯¯ç±»å‹ç³»ç»Ÿ
  - é”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–
- **é”™è¯¯æ¢å¤**ï¼š
  - ä¼˜é›…çš„é”™è¯¯å¤„ç†ï¼ˆè€Œéç›´æ¥ `exit(1)`ï¼‰
  - é”™è¯¯æ ˆè·Ÿè¸ª

#### å®ç°è¦ç‚¹
1. å®ç°å¼‚å¸¸ç³»ç»Ÿï¼ˆå¯åŸºäº continuationï¼‰
2. é”™è¯¯ç±»å‹å®šä¹‰
3. é”™è¯¯å¤„ç†æµç¨‹æ”¹è¿›

### 2.5 æ›´å¤šç‰¹æ®Šå½¢å¼ âŒ

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ ä¸­

#### ç¼ºå¤±åŠŸèƒ½
- `case expr clause ...`ï¼šå¤šè·¯åˆ†æ”¯
- `and expr ...`ï¼šé€»è¾‘ä¸ï¼ˆçŸ­è·¯æ±‚å€¼ï¼‰
- `or expr ...`ï¼šé€»è¾‘æˆ–ï¼ˆçŸ­è·¯æ±‚å€¼ï¼‰
- `delay expr`ï¼šå»¶è¿Ÿæ±‚å€¼ï¼ˆPromiseï¼‰
- `force promise`ï¼šå¼ºåˆ¶æ±‚å€¼

#### å®ç°è¦ç‚¹
1. `case`ï¼šå¯é€šè¿‡å®å±•å¼€å®ç°
2. `and`/`or`ï¼šéœ€è¦çŸ­è·¯æ±‚å€¼ï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šå½¢å¼
3. `delay`/`force`ï¼šæ·»åŠ  `PROMISE` ç±»å‹

### 2.6 æ›´å¤šå†…ç½®å‡½æ•° âŒ

**ä¼˜å…ˆçº§**ï¼šğŸŸ¢ ä½

#### ç¼ºå¤±åŠŸèƒ½
- **å­—ç¬¦æ“ä½œ**ï¼š
  - `char=?`, `char<?`, `char>?`ï¼šå­—ç¬¦æ¯”è¾ƒ
  - `char-upcase`, `char-downcase`ï¼šå¤§å°å†™è½¬æ¢
- **å­—ç¬¦ä¸²æ“ä½œ**ï¼š
  - `string=?`, `string<?`ï¼šå­—ç¬¦ä¸²æ¯”è¾ƒ
  - `substring`, `string-append`ï¼šå­—ç¬¦ä¸²æ“ä½œ
  - `string->list`, `list->string`ï¼šè½¬æ¢
- **å‘é‡æ“ä½œ**ï¼š
  - `vector-length`, `vector-ref`, `vector-set!`
  - `vector->list`, `list->vector`
- **ç³»ç»Ÿæ“ä½œ**ï¼š
  - `exit code`ï¼šé€€å‡ºç¨‹åº
  - `transcript-on filename`ï¼šå¼€å§‹è®°å½•
  - `transcript-off`ï¼šåœæ­¢è®°å½•

### 2.7 Guile API å…¼å®¹å±‚ âŒ

**ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜

TeXmacs é€šè¿‡ Guile C API ä¸ Scheme äº¤äº’ã€‚

#### ç¼ºå¤±åŠŸèƒ½
- **åŸºæœ¬æ“ä½œ**ï¼š
  ```c
  SCM scm_cons(SCM car, SCM cdr);
  SCM scm_car(SCM pair);
  SCM scm_cdr(SCM pair);
  SCM scm_list1(SCM obj1);
  SCM scm_list2(SCM obj1, SCM obj2);
  SCM scm_list3(SCM obj1, SCM obj2, SCM obj3);
  ```
- **æ±‚å€¼**ï¼š
  ```c
  SCM scm_eval(SCM expr, SCM env);
  SCM scm_eval_string(const char* str);
  SCM scm_eval_file(const char* filename);
  ```
- **ç¯å¢ƒ**ï¼š
  ```c
  SCM scm_interaction_environment();
  SCM scm_current_module();
  ```
- **å˜é‡æ“ä½œ**ï¼š
  ```c
  void scm_define(SCM env, SCM symbol, SCM value);
  SCM scm_lookup(SCM env, SCM symbol);
  ```
- **è¿‡ç¨‹è°ƒç”¨**ï¼š
  ```c
  SCM scm_call(SCM proc, SCM args);
  SCM scm_apply(SCM proc, SCM args);
  ```
- **é”™è¯¯å¤„ç†**ï¼š
  ```c
  void scm_error(const char* subr, const char* fmt, ...);
  SCM scm_catch(SCM tag, SCM* (*thunk)(void*), void* data,
                SCM* (*handler)(void*, SCM), void* handler_data);
  ```

#### å®ç°è¦ç‚¹
1. åˆ›å»º `guile_compat.h` å’Œ `guile_compat.cc`
2. ç±»å‹è½¬æ¢ï¼š`SCM*` â†” `SCM`ï¼ˆvoid*ï¼‰
3. API æ˜ å°„ï¼šå°†å†…éƒ¨å®ç°æ˜ å°„åˆ° Guile API
4. è¡Œä¸ºä¸€è‡´æ€§ï¼šç¡®ä¿ä¸ Guile 1.8 è¡Œä¸ºä¸€è‡´

### 2.8 åƒåœ¾å›æ”¶ï¼ˆGCï¼‰âŒ

**ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜

å½“å‰æ‰€æœ‰å†…å­˜éƒ½ä¸ä¼šé‡Šæ”¾ï¼Œå­˜åœ¨å†…å­˜æ³„æ¼ã€‚

#### å®ç°æ–¹æ¡ˆ
1. **æ ‡è®°-æ¸…é™¤ï¼ˆMark-and-Sweepï¼‰**ï¼š
   - æ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡
   - æ¸…é™¤æœªæ ‡è®°å¯¹è±¡
2. **æ ¹å¯¹è±¡æ³¨å†Œ**ï¼š
   - å…¨å±€ç¯å¢ƒ
   - Continuation æ ˆ
   - å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡
3. **å¯¹è±¡éå†**ï¼š
   - é€’å½’éå†æ‰€æœ‰å¼•ç”¨
   - æ ‡è®°å¯è¾¾å¯¹è±¡

#### å®ç°è¦ç‚¹
1. ç»Ÿä¸€å†…å­˜åˆ†é…æ¥å£
2. å¯¹è±¡æ ‡è®°æœºåˆ¶
3. GC è§¦å‘æ—¶æœºï¼ˆåˆ†é…æ—¶ã€æ‰‹åŠ¨è§¦å‘ï¼‰
4. ä¸ continuation çš„å…¼å®¹æ€§

### 2.9 æ€§èƒ½ä¼˜åŒ– âš ï¸

**ä¼˜å…ˆçº§**ï¼šğŸŸ¢ ä½

#### å½“å‰é—®é¢˜
- ç¯å¢ƒæŸ¥æ‰¾ï¼šO(n) çº¿æ€§æœç´¢
- ç¬¦å·æ¯”è¾ƒï¼šä½¿ç”¨ `memcmp`

#### ä¼˜åŒ–æ–¹å‘
1. **ç¯å¢ƒæŸ¥æ‰¾ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨å“ˆå¸Œè¡¨ä¼˜åŒ–ç¯å¢ƒæŸ¥æ‰¾ï¼ˆå“ˆå¸Œè¡¨å·²å®ç°ï¼‰
   - å°†æŸ¥æ‰¾å¤æ‚åº¦é™è‡³ O(1)
2. **ç¬¦å·è¡¨ä¼˜åŒ–**ï¼š
   - ç¬¦å·å»é‡ï¼ˆinterningï¼‰
   - å¿«é€Ÿç¬¦å·æ¯”è¾ƒ
3. **å…¶ä»–ä¼˜åŒ–**ï¼š
   - çƒ­ç‚¹ä»£ç è¯†åˆ«
   - å°¾è°ƒç”¨ä¼˜åŒ–æ”¹è¿›

